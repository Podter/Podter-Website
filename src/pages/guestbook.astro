---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import { authConfig } from "@/constants/auth";
import Auth from "@/components/guestbook/Auth";
import Form from "@/components/guestbook/Form";
import MessageServer from "@/components/guestbook/MessageServer.astro";
import initPrisma from "@/lib/prisma";

export const prerender = false;

const prisma = initPrisma();

const session = await getSession(Astro.request, authConfig);

const messages = await prisma.messages.findMany({
  orderBy: {
    created: "desc",
  },
  select: {
    provider: true,
    providerAccountId: true,
    message: true,
  },
});

const existing = messages.find(
  (message) => message.providerAccountId === session?.user.providerAccountId,
);
---

<Layout title="Guestbook" description="Sign my guestbook and leave your mark.">
  <div class="mt-6">
    {
      session ? (
        <Form session={session} existing={existing} client:visible />
      ) : (
        <Auth client:visible />
      )
    }
  </div>
  <div class="flex flex-col mt-6 gap-3">
    {messages.map((message) => <MessageServer message={message} />)}
  </div>
</Layout>
